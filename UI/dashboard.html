<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <meta content="Online Public Bus Transportation Booking Service" name="description">
    <meta content="Gildas Niyigena" name="author">
    <title>WayFarer - Dashboard</title>
    <link href="./css/style.css" rel="stylesheet">
    <link href="./css/font-awesome.min.css" rel="stylesheet">
</head>
<body>
<div class="page-container not-visible">
    <nav class="client-nav">
        <div class="logo"></div>
        <div class="btn-wrapper">
            <div class="btn primary logout can__see-dashboard" id="user-logout">logout</div>
        </div>

    </nav>
    <div class="content-wrapper">
        <div class="column column-l">
            <!--                STARTS - TRIPS LIST -->
            <div class="trip--filter-container can__view_all_trips"></div>
            <div class="trip--list-container can__view_all_trips">
                <table border="1" class="table-header">
                    <tr>
                        <th>DEPARTURE</th>
                        <th>DESTINATION</th>
                        <th>DATE</th>
                        <th>TIME</th>
                        <th>BUS PLATE</th>
                        <th>ACTION</th>
                    </tr>
                </table>
                <div class="scroll">
                    <table class="trip--table" id="all-trips">
                    </table>
                </div>
            </div>
            <div class="pager-container can__view_all_trips"></div>
            <!--            ENDS - TRIPS LIST -->

            <!--            STARTS - TRIP CREATE FORM -->
            <!--            ENDS - TRIP CREATE FORM -->

            <!--            STARTS - SINGLE TRIP VIEW -->
            <div class="trip--container can__view_a_trip is__hidden">
                <div class="trip--bus-wrapper">
                    <table id="bus-seats"></table>
                </div>
                <div class="trip--details">
                    <h2>TRIP DETAILS</h2>
                    <ul>
                        <li>DEPARTURE <span id="trip-departure"></span></li>
                        <li>DESTINATION <span id="trip-destination"></span></li>
                        <li>DATE <span id="trip-date"></span></li>
                        <li>TIME <span id="trip-time"></span></li>
                        <li>BUS PLATE NO <span id="trip-plate-no"></span></li>
                        <li>DRIVER NAME <span id="trip-driver-name"></span></li>
                    </ul>
                    <button class="trip--close btn default">BACK TO THE LIST</button>
                    <button class="btn default" disabled="disabled" id="submit-bookings">PICK SOME SEATS</button>
                </div>
            </div>
            <!--            ENDS - SINGLE TRIP VIEW -->
        </div>
        <div class="column column-r">
            <!--            <div class="switch can__create_a_trip">-->
            <!--                <button id="switch-form-bookings" class="btn default">VIEW BOOKINGS</button>-->
            <!--            </div>-->
            <div class="trip--create-form can__create_a_trip">
                <h2>CREATE A TRIP</h2>
                <form id="create-new-trip" method="post">
                    <p class="trip--create-input-group">
                        <label for="create-trip-departure">Departure</label>
                        <select class="trip--create-input" id="create-trip-departure" name="create-trip-departure">
                            <option disabled="disabled" selected value="">Select a Departure Place</option>
                        </select>
                    </p>
                    <p class="trip--create-input-group">
                        <label for="create-trip-destination">Destination</label>
                        <select class="trip--create-input" id="create-trip-destination" name="create-trip-destination">
                            <option disabled="disabled" selected value="">Select a Destination place</option>
                        </select>
                    </p>
                    <p class="trip--create-input-group">
                        <label for="create-trip-date">Date</label>
                        <select class="trip--create-input" id="create-trip-date" name="create-trip-date">
                            <option disabled="disabled" selected value="">Select a trip date</option>
                        </select>
                    </p>
                    <p class="trip--create-input-group">
                        <label for="create-trip-time">Time</label>
                        <select class="trip--create-input" id="create-trip-time" name="create-trip-time">
                            <option disabled="disabled" selected value="">Select a departure time</option>
                        </select>
                    </p>
                    <p class="trip--create-input-group">
                        <label for="create-trip-bus">Bus Plate</label>
                        <select class="trip--create-input" id="create-trip-bus" name="create-trip-bus">
                            <option disabled="disabled" selected value="">Select the trip bus</option>
                        </select>
                    </p>
                    <p class="trip--create-input-group submit-switch">
                        <input class="btn primary submit-btn" id="trip-create_submit" name="trip-create_submit"
                               type="button"
                               value="Submit">
                        <a class="btn default" id="switch-form-bookings">VIEW BOOKINGS</a>
                    </p>
                </form>
            </div>
            <div class="bookings is__hidden">
                <div class="booking--filter-container can__view_user_bookings"></div>
                <div class="booking--list-container">
                    <p>ARE YOU HIDDEN?</p>
                </div>
                <p>
                    <a class="btn default" id="switch-bookings-form">VIEW BOOKINGS</a>
                </p>
            </div>
        </div>
    </div>
    <footer class="footer">
        <p>
            &copy; Gildas Niyigena, <span id="year">2018</span> <span class="can__create_a_trip">Admin</span> <span
                class="can__view-own-bookings">User</span>
        </p>
    </footer>
</div>
<script type="application/javascript">

    "use strict";

    if (!localStorage.getItem('loggedUserId')) {

        // IF THE USER IS NOT AUTHENTICATED HE/SHE'S REDIRECTED TO THE HOME

        localStorage.setItem('needToBeLogged', Date.now() + '');
        window.location.replace('index.html');
    } else {
        // ONLY ACCESS THE DASHBOARD IF THE USER IS AUTHENTICATED
        let loggedUserId = null;
        loggedUserId = (localStorage.getItem('loggedUserId')) * 1;

        // STARTS - HELPERS FUNCTIONS
        const elsByClass = (c) => document.getElementsByClassName(c);
        const elById = (id) => !!document.getElementById(id) && document.getElementById(id);
        const rangeFrom1To = n => [...Array(n)].map((_, i) => i + 1);
        const shuffle = arr => {
            const newArr = arr.slice();
            for (let i = newArr.length - 1; i > 0; i--) {
                const rand = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[rand]] = [newArr[rand], newArr[i]];
            }
            return newArr
        };

        const sort = (arr, field) => arr.sort((a, b) => (a[field] > b[field]) ? 1 : -1);

        const reverseList = ([x, ...s]) => x ? [...reverseList(s), x] : [];

        // ENDS - HELPERS FUNCTIONS

        // As the oage container was hidden to the no-authenticated user
        // This help to not load html before javascript is loaded
        const pageContainer = [...elsByClass('not-visible')][0];
        pageContainer.classList.remove('not-visible');

        // Current year for copyright
        const currentTime = new Date();
        elById("year").innerHTML = '' + currentTime.getFullYear();

        fetch("./db.json").then(res => res.json()).then(db => {

            const buses = db['buses'];
            const places = db['places'];
            const users = db['users'];
            const trips = [];
            const seats = [];
            let currentUser;

            // Get the logged user object
            if (loggedUserId) currentUser = users.filter(user => user.id === loggedUserId)[0];
            else window.location.replace('index.html');

            // Claims / Permissions
            const claims = [
                'create_a_trip',
                'cancel_a_trip',
                'view_users_bookings',
                'view_user_bookings',
                'see-dashboard',
                'view_all_trips',
                'view_a_trip',
                'view_own_bookings',
                'book_a_trip',
                'delete_own_bookings'
            ];

            let adminClaims = [], userClaims = [];

            claims.forEach((value, index) => {
                if (index <= 6) adminClaims.push(value);
                if (index >= 4) userClaims.push(value)
            });

            const currentUserClaims = currentUser && (currentUser.role === 'admin' ? adminClaims : userClaims) || '';

            // Logout the user
            elById('user-logout').addEventListener('click', e => {
                localStorage.removeItem('loggedUserId');
                window.location.replace('index.html');
            });


            // BUILD FAKE TRIPS
            // Build the departure times being every 30 min from 4am to 8pm
            let departureTimes = [];

            for (let i = 4; i <= 20; i++) {
                i = i >= 10 ? `${i}` : `0${i}`;
                for (let j = 0; j <= 1; j++) {
                    j = j === 0 ? `00` : `30`;
                    const time = `${i}:${j}`;
                    departureTimes.push(time);
                }
            }

            // Build 30 days (coming) to be listed when creating a trip
            // And 30 past days (max) to be shown in the list of past trips
            let past30days = [];
            let coming30days = [];

            for (let i = -30; i < 30; i++) {
                const today = new Date();
                const date = today.setDate(today.getDate() + i);
                let day = (new Date(date)).getDate();
                let month = (new Date(date)).getMonth() + 1;
                day = day < 10 ? `0${day}` : day;
                month = month < 10 ? `0${month}` : month;
                const dates = {id: i + 31, date: `${day}/${month}/${(new Date(date)).getFullYear()}`};
                i >= 0 && coming30days.push(dates);
                i < 0 && past30days.push(dates);
            }

            // Trip id format 01-02-08/07/2019-14:30-02
            // Where:
            // [01] :           Departure place
            // [02] :           Destination place
            // [08/07/2019] :   Trip date
            // [14:30] :        Trip time
            // [02] :           Bus id

            // Seats numbers for each trip, considering a bus of 40 seats
            let s = 1, seatNumbers = [];
            while (s <= 20) seatNumbers.push(...[`${s}A`, `${s}B`]) && s++;

            // No more than 1 trip can be Same DEPARTURE, DESTINATION and DATE-TIME
            // No more than 1 trip can be Same DATE-TIME and BUS
            // No BUS may be assigned to a trip planned in less than 60 min of its previous trip

            // Trips random creation

            // Random 20 DEPARTURE-DESTINATION pairs (DEPARTURE may always differ from DESTINATION)


            const allTripsElements = elsByClass('can__view_all_trips');
            const singleTripElements = elsByClass('can__view_a_trip');

            // Check if need to show list or the single Trip
            const toggleSingleAllView = () => {
                if (openedTripId) {
                    [...allTripsElements].forEach(el => el['classList'].add('is__hidden'));
                    [...singleTripElements].forEach(el => el['classList'].remove('is__hidden'));
                } else {
                    console.log('TO ALL');
                    [...allTripsElements].forEach(el => el['classList'].remove('is__hidden'));
                    [...singleTripElements].forEach(el => el['classList'].add('is__hidden'));
                }
            };

            const createButton = (el, value = null, classes = null, id = null, fun = null) => {
                const btn = document.createElement('input');
                btn.type = 'button';
                classes && (btn.className = classes);
                id && (btn.id = id);
                value && (btn.value = value);
                fun && (btn.onclick = fun);
                el.appendChild(btn);
            };

            const placeIds = rangeFrom1To(5);
            let randDepartDest = [], randDates = [], i = 1;
            const randIndex = shuffle(rangeFrom1To(4))[0];

            do {
                const dep = shuffle(placeIds), des = shuffle(placeIds);
                if (dep[randIndex] !== des[randIndex]) randDepartDest.push(`0${dep[randIndex]}-0${des[randIndex]}`);
                if (randDepartDest.length === 100) break;
                i++
            } while (i <= 500);

            do {
                const shuffledDates = shuffle([...past30days, ...coming30days]);
                randDates.push(shuffledDates[randIndex]);
                if (randDates.length === 100) break;
                i++
            } while (i <= 500);

            let dateTimeFromRanDates = [];
            const randDatesSorted = sort(randDates, 'id');

            randDatesSorted.forEach(date => {
                departureTimes.forEach(time => {
                    dateTimeFromRanDates.push(`${date.date}-${time}`)
                });
            });
            const dt = [];
            dateTimeFromRanDates.forEach((value, index) => dt.push({id: index, date: value}));
            dateTimeFromRanDates = sort(((shuffle(dt)).slice(0, 100)), 'id');

            const depDesDatetimeList = [], datetimeBusList = [], uniqueDepDesDatetimeBusList = [];

            dateTimeFromRanDates.forEach(dt => {
                randDepartDest.slice(0, 10).forEach(dd => depDesDatetimeList.push([dd, dt.date]));
                buses.forEach(bus => {
                    datetimeBusList.push([bus.id, dt.date])
                });
            });

            const newDepDesDatetimeList = [];
            const newDepDatetimeBusList = [];
            for (let i = 0; i < 1000; i++) {
                if (
                    !newDepDesDatetimeList.includes(depDesDatetimeList[i]) &&
                    !newDepDatetimeBusList.includes(datetimeBusList[i])
                ) {
                    newDepDesDatetimeList.push(depDesDatetimeList[i]);
                    newDepDatetimeBusList.push(datetimeBusList[i]);
                }
            }

            for (let i = 0; i < newDepDatetimeBusList.length; i++) {
                uniqueDepDesDatetimeBusList.push({
                    id: i,
                    trip: `${newDepDesDatetimeList[i][0]}-${newDepDesDatetimeList[i][1]}-${newDepDatetimeBusList[i][0] === 10 ? 10 : '0' + newDepDatetimeBusList[i][0]}`
                })
            }

            // Shuffle the List of Unique DEPARTURE-DESTINATION-DATETIME-BUS objects,
            // first 100 of the list and reorder the new list base of the increasing ids
            // And push the results in the trips array
            (sort((shuffle(uniqueDepDesDatetimeBusList)).slice(0, 100), 'id')).forEach(e => trips.push({id: e.trip}));

            // The result from the above TRIPS list is used to build seats (40 by trip)
            // And assigned to the users randomly
            trips.forEach(t => {
                seatNumbers.forEach((val, idx) => {

                    // Make the 10 available users book a few of the seats randomly
                    const bookingGenerator = [];
                    (shuffle(rangeFrom1To(seatNumbers.length))).forEach(nbr => {
                        nbr = nbr > 10 ? 0 : nbr;
                        bookingGenerator.push(nbr)
                    });
                    seats.push({trip_id: t.id, booked: bookingGenerator[idx], number: val})
                })
            });

            console.group('My data');
            console.group();
            console.log('Buses:');
            console.log(buses);
            console.groupEnd();
            console.group();
            console.log('Places:');
            console.log(places);
            console.groupEnd();
            console.group();
            console.log('Users:');
            console.log(users);
            console.groupEnd();
            console.group();
            console.log('Trips:');
            console.log(trips);
            console.groupEnd();
            console.group();
            console.log('Seats:');
            console.log(seats);
            console.groupEnd();
            console.group();
            console.log('Claims:');
            console.log(claims);
            console.groupEnd();
            console.groupEnd();

            // Restrict access based on claims
            currentUserClaims.forEach(claim => {
                const allClaimsElements = document.querySelectorAll('[class^=can__]');
                const allowedClaimsElements = elsByClass(`can__${claim}`);
                const notAllowedClaimsElements = [...allClaimsElements].filter(element => ![...allowedClaimsElements].includes(element));
                [...notAllowedClaimsElements].forEach(element => element['classList'].add('not-allowed'))
            });

            // Current User trips
            const currentUserSeats = seats.filter(seat => seat.booked === loggedUserId);

            const currentUserTrips = [];
            trips.forEach(trip => {
                if (currentUserSeats.map(seat => seat.trip_id).includes(trip.id)) {
                    currentUserTrips.push(trip);
                }
            });

            // Add the Trips to the html trips table
            const allTipsTable = elById('all-trips');


            // Opening a trip from the list
            let openedTripId = null;

            const tripArrayFromTrip = trip => {
                let arr = trip['id'] && trip['id'].trim().split('-');
                return arr && [arr[0] * 1, arr[1] * 1, arr[2], arr[3], arr[4] * 1];
            };

            // Book a seat by clicking on it
            let chosenSeatsElements;

            // Single Trip Actions
            const handleSingleTripDisplay = trip => {

                const tripArray = tripArrayFromTrip(trip);
                const tripDeparture = (places.filter(place => place.id === tripArray[0])[0])['name'];
                const tripDestination = (places.filter(place => place.id === tripArray[1])[0])['name'];
                const tripDate = tripArray[2];
                const tripTime = departureTimes.filter(time => time === tripArray[3])[0];
                const tripBusPlate = (buses.filter(bus => bus.id === tripArray[4] * 1)[0])['plate_no'];
                const tripBusDriverName = (buses.filter(bus => bus.id === tripArray[4] * 1)[0])['driver_name'];
                const tripSeats = seats.filter(seat => seat.trip_id === trip.id);
                const currentUserBookedSeatsOnTripIDs = () => (tripSeats.filter(seat => seat.booked === currentUser.id)).map(el => el.number);
                const submitBookingsBtn = elById('submit-bookings');

                elById('trip-departure').innerText = tripDeparture;
                elById('trip-destination').innerText = tripDestination;
                elById('trip-date').innerText = tripDate;
                elById('trip-time').innerText = tripTime;
                elById('trip-plate-no').innerText = tripBusPlate;
                elById('trip-driver-name').innerText = tripBusDriverName;

                const clickToChooseSeat = (el) => {
                    if (el.classList.contains('is__chosen-seat')) el.classList.remove("is__chosen-seat");
                    else el.classList.add('is__chosen-seat');

                    chosenSeatsElements = (elsByClass('is__chosen-seat'));

                    console.log(chosenSeatsElements.length);

                    if (chosenSeatsElements.length) {
                        submitBookingsBtn.classList.add('primary');
                        submitBookingsBtn.classList.remove('default');
                        submitBookingsBtn.disabled = false;
                        submitBookingsBtn.innerText = chosenSeatsElements.length > 1 ? 'SUBMIT BOOKINGS' : 'SUBMIT BOOKING';
                    } else {
                        submitBookingsBtn.classList.remove('primary');
                        submitBookingsBtn.classList.add('default');
                        submitBookingsBtn.disabled = true;
                        submitBookingsBtn.innerText = 'PICK SOME SEATS';
                    }
                };

                let busSeatsTable = null;

                busSeatsTable = elById('bus-seats');

                // Close a trip and go back to the list view
                const tripCloseBtn = elsByClass('trip--close')[0];
                tripCloseBtn.onclick = () => {

                    openedTripId = null;
                    while (busSeatsTable.firstChild) {
                        busSeatsTable.removeChild(busSeatsTable.firstChild);
                    }
                    toggleSingleAllView();
                };

                const bookedSeats = tripSeats.filter(e => e.booked !== 0 && e.booked !== loggedUserId);
                const AvailableSeatsLeft = tripSeats.length - bookedSeats.length;

                const buildBusSeats = () => {
                    for (let i = 0; i < 12; i++) {

                        const row = busSeatsTable.insertRow(i);
                        const td1 = row.insertCell(0);
                        const td2 = row.insertCell(1);
                        const td3 = row.insertCell(2);
                        const td4 = row.insertCell(3);
                        const td5 = row.insertCell(4);
                        td1.classList.add('bus-side');
                        td1.classList.add('left');
                        td5.classList.add('bus-side');
                        td5.classList.add('right');

                        if (i > 1) {
                            td3.classList.add('corridor');
                            createButton(td2, (i * 2) - 3 + 'A', 'trip--seat', (i * 2) - 3 + 'A', e => clickToChooseSeat(e.target));
                            createButton(td2, (i * 2) - 3 + 'B', 'trip--seat', (i * 2) - 3 + 'B', e => clickToChooseSeat(e.target));
                            createButton(td4, (i * 2) - 2 + 'B', 'trip--seat', (i * 2) - 2 + 'B', e => clickToChooseSeat(e.target));
                            createButton(td4, (i * 2) - 2 + 'A', 'trip--seat', (i * 2) - 2 + 'A', e => clickToChooseSeat(e.target));

                            if (i === 11) {
                                td2.classList.add('last-seat');
                                td3.classList.add('last-seat');
                                td4.classList.add('last-seat');
                            }

                            if (i === 2 || i === 9) {
                                td1.classList.add('tyre-left');
                                td5.classList.add('tyre-right');
                            }
                        } else if (i === 1) {
                            createButton(td2, 'DRIVER', null, '00', null);
                            createButton(td4, 'EXIT >>', null, 'bus-door', null);
                            td2.classList.add('driver');
                            td4.classList.add('bus-door');
                            td3.innerText = AvailableSeatsLeft + ' LEFT';
                        } else {
                            td1.classList.add('mirror');
                            td1.classList.add('left');
                            td5.classList.add('mirror');
                            td5.classList.add('right');
                            td2.classList.add('front');
                            td3.classList.add('front');
                            td4.classList.add('front');
                            td2.innerText = 'BUS';
                            td3.innerText = 'FRONT';
                            td4.innerText = 'SIDE';
                        }
                    }
                };
                buildBusSeats();

                // Get the already booked seats by the current user in the current Trip
                const userBookedSeatsOnTripIDList = currentUserBookedSeatsOnTripIDs();
                userBookedSeatsOnTripIDList.forEach(id => {
                    const ownSeatsBtnEl = elById(id);
                    ownSeatsBtnEl.classList.add('seat-own-booked');
                    ownSeatsBtnEl.classList.add('seat-own-booked');
                    ownSeatsBtnEl.title = 'Already in my bookings';
                });

                // Add event handler to the Booking Button
                submitBookingsBtn.addEventListener('click', () => {
                    const testArray = tripSeats.filter(seat => [...chosenSeatsElements].map(e => e['id']).includes(seat.number));
                    console.log(testArray); // TODO Submit and add to the array
                }, false);

                // Prevent already booked seat to be selectable
                bookedSeats.forEach(seat => {
                    const bookedSeatBtn = elById(seat.number);
                    bookedSeatBtn.classList.add('seat-booked');
                    bookedSeatBtn.title = 'Booked by someone';
                });
            };

            // WE LIST ALL TRIPS WITH ORDER DESCENDENT
            const tripsDescendent = [];

            const displayTripsList = (tripsToBeReversed) => {

                tripsDescendent.push(...reverseList(tripsToBeReversed));

                tripsDescendent.forEach((trip, i) => {
                    const newRow = allTipsTable.insertRow(i);
                    const tripArray = tripArrayFromTrip(trip);

                    // if (i === tripsDescendent.length - 1) console.log(tripArray/*places.filter(place => place.id === tripArray[0])[0]*/);

                    // Trip Departure Place Id
                    newRow.insertCell(0).innerHTML = (places.filter(place => place.id === tripArray[0])[0])['name'];

                    // Trip Destination Place Id
                    newRow.insertCell(1).innerHTML = (places.filter(place => place.id === tripArray[1])[0])['name'];

                    // Trip Departure Date
                    newRow.insertCell(2).innerHTML = tripArray[2];

                    // Trip Departure Time
                    newRow.insertCell(3).innerHTML = departureTimes.filter(time => time === tripArray[3])[0];

                    // Trip Bus PlateNo
                    newRow.insertCell(4).innerHTML = (buses.filter(bus => bus.id === tripArray[4] * 1)[0])['plate_no'];

                    // Open Button
                    createButton(newRow.insertCell(5), 'Open', 'btn primary book can__view_a_trip', null, () => {
                        openedTripId = trips[i].id;
                        toggleSingleAllView();
                        handleSingleTripDisplay(trips[i])
                    })
                });
                console.log('IN THE FUNCTION: ', tripsDescendent[tripsDescendent.length - 1].id)
            };

            let tripCreateInputs = [...elsByClass('trip--create-input')];

            // CREATE A TRIP WITH A FORM
            const createDepartureElement = elById('create-trip-departure');
            const createDestinationElement = elById('create-trip-destination');
            const createDateElement = elById('create-trip-date');
            const createTimeElement = elById('create-trip-time');
            const createBusElement = elById('create-trip-bus');

            const createDepartmentElmentFn = () => places.forEach((place, i) => {
                const opt = document.createElement("option");
                opt.text = place.name;
                opt.value = place.id;
                createDepartureElement.add(opt, createDepartureElement[i + 1])
            });

            const createDestinationElmentFn = () => places.forEach((place, i) => {
                const opt = document.createElement("option");
                opt.text = place.name;
                opt.value = place.id;
                createDestinationElement.add(opt, createDestinationElement[i + 1])
            });

            const createDateElmentFn = () => coming30days.forEach((date, i) => {
                const opt = document.createElement("option");
                opt.text = date.date;
                opt.value = date.date;
                createDateElement.add(opt, createDateElement[i + 1])
            });

            const createTimeElmentFn = () => departureTimes.forEach((time, i) => {
                const opt = document.createElement("option");
                opt.text = time;
                opt.value = time;
                createTimeElement.add(opt, createTimeElement[i + 1])
            });

            const createBusElmentFn = () => buses.forEach((bus, i) => {
                const opt = document.createElement("option");
                opt.text = bus['plate_no'];
                opt.value = bus.id;
                createBusElement.add(opt, createBusElement[i + 1])
            });

            createDepartmentElmentFn();
            createDestinationElmentFn();
            createDateElmentFn();
            createTimeElmentFn();
            createBusElmentFn();

            const tripCreateSelectElementsList = [
                createDepartureElement,
                createDestinationElement,
                createDateElement,
                createTimeElement,
                createBusElement
            ];

            // Listen to any change of the select box and update the submit button
            const tripCreateSubmitBtn = elById('trip-create_submit');
            tripCreateSubmitBtn.setAttribute('disabled', true);
            createDestinationElement.disabled = true;

            tripCreateSelectElementsList.forEach(e => e.addEventListener('change', event => {

                // To prevent that the Departure can be also the Destination place
                if (e.id === createDepartureElement.id) {
                    createDestinationElement.disabled = false;
                    [...createDestinationElement.options].forEach((option, i) => i !== 0 && (option.hidden = false));
                    [...createDestinationElement.options].filter(option => option['value'] === event.target.value)[0].setAttribute('hidden', 'hidden');/*.disabled = true*/

                    // Remove the selection of the second Destination
                    if (createDepartureElement.selectedIndex === createDestinationElement.selectedIndex) {
                        createDestinationElement.selectedIndex = 0;
                    }
                }
                const selectedDate = createDateElement.options[createDateElement.selectedIndex].value;
                const selectedTime = createTimeElement.options[createTimeElement.selectedIndex].value;

                [...createBusElement.options].forEach((opt, i) => {
                    if (selectedDate && selectedTime) {

                        const selectedDayBusesTrips = tripsDescendent
                            .map(trip => trip.id)
                            .filter(id => id.includes(selectedDate) && id.endsWith((i === 10 ? '' : '0') + opt['id']));

                        if (selectedDayBusesTrips.length > 0) {
                            selectedDayBusesTrips.forEach(trip => {

                                const selectedDayTripTimes = tripArrayFromTrip(trip) && tripArrayFromTrip(trip)[3];
                                console.log(selectedDayTripTimes)
                            })
                        }
                    }
                });


                const isAnyEmptyFormElement = tripCreateSelectElementsList.map(el => el['value']).filter(e => e === '');
                console.log(isAnyEmptyFormElement);

                if (isAnyEmptyFormElement.length) {
                    tripCreateSubmitBtn.disabled = true;
                } else {
                    tripCreateSubmitBtn.disabled = false;
                    tripCreateSubmitBtn.addEventListener('click', ev => {

                        const tripFormValues = tripCreateInputs.map(e => e['value']);
                        const newTripId = `0${tripFormValues[0]}-0${tripFormValues[1]}-${tripFormValues[2]}-${tripFormValues[3]}-0${tripFormValues[4]}`;

                        trips.push({id: newTripId});
                        // // Add message of success

                        elById('create-new-trip').reset();

                        // console.log('BEFORE THE FUNCTION: ', tripFormValues);

                        displayTripsList(trips);
                    });
                }

            }));

            displayTripsList(trips);
            //  FILTERING TRIPS ON THE USERS TRIP LIST

            // SWITCH FROM CREATE FORM TO VIEW TRIPS LIST FOR THE ADMIN AND VICE VERSA

            const switchFormBookings = () => {
                elById('switch-form-bookings').addEventListener('click', event => {
                    [...elsByClass('trip--create-form')][0].classList.add('is__hidden');
                    [...elsByClass('bookings')][0].classList.remove('is__hidden');
                });
                elById('switch-bookings-form').addEventListener('click', event => {
                    [...elsByClass('bookings')][0].classList.add('is__hidden');
                    [...elsByClass('trip--create-form')][0].classList.remove('is__hidden');
                })
            };

            switchFormBookings()
        });
    }
</script>
</body>
</html>
